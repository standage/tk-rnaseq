#!/usr/bin/env make -f

# Copyright (c) 2013, Daniel S. Standage <daniel.standage@gmail.com>
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.


# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------


SHELL := /usr/bin/env bash
MKFILE=$(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))
BINDIR=$(shell dirname $(MKFILE))
define PROG_USAGE

build-table: asdf

Usage: build-table [options] args
  Options:


endef
export PROG_USAGE


# Program options
#ifndef ebseqinfile
#  $(error ebseqinfile is not specified $(PROG_USAGE))
#endif
#ifndef ebseqoutfile
#  $(error ebseqoutfile is not specified $(PROG_USAGE))
#endif
#ifndef samfilepattern
#  $(error samfilepattern is not specified $(PROG_USAGE))
#endif
workdir=.
samfilelist=$(shell ls $(samfilepattern) | tr '\n' ' ')


# Data files
foldchanges=$(workdir)/foldchanges.txt
readsmapped=$(workdir)/readsmapped.txt
output=$(workdir)/expression-data.txt
exprdata=$(workdir)/exprdata.txt


usage:
			@- echo "$$PROG_USAGE"

help:			usage
			

all:			$(output)
			

$(BINDIR)/smr:		$(BINDIR)/smr.cpp
			g++ -Wall -O3 -std=c++11 -o $(BINDIR)/smr $(BINDIR)/smr.cpp

$(foldchanges).temp:	$(ebseqoutfile)
			$(BINDIR)/addmag < $(ebseqoutfile) > $(foldchanges)

$(readsmapped).temp:	$(samfilelist) $(BINDIR)/smr
			$(BINDIR)/smr --delim='\t' --outfile=$(readsmapped) $(samfilelist)

$(exprdata):		$(ebseqinfile)
			$(BINDIR)/norm-check --before=$(workdir)/pre-norm.png --after=$(workdir)/post-norm.png --out=$(exprdata).norm.temp < $(ebseqinfile)
			cat <(head -n 1 $(ebseqinfile) | perl -ne 'print "mol"; s/"([\t|\n])/.norm"$$1/g; print') <(tail -n +2 $(exprdata).norm.temp) > $(exprdata).norm
			paste $(ebseqinfile) <(cut -f 2- $(exprdata).norm) > $(exprdata)



