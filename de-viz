#!/usr/bin/env make -f
SHELL := /usr/bin/env bash

# Program options
BINDIR=.
WORKDIR=$(BINDIR)
RSEMFILE=$(WORKDIR)/expr.rsem.dat
EBSEQFILE=$(WORKDIR)/diffexp.ebseq.dat
PNG=$(WORKDIR)/heatmap.png
ifdef SAMPLES
  SAMPLEARG= --samples=$(SAMPLES)
endif

all:						$(WORKDIR) $(PNG)

$(WORKDIR):					
						test -d $(WORKDIR) || mkdir $(WORKDIR)

$(WORKDIR)/diffexp.molids.txt:			$(EBSEQFILE)
						tail -n +2 $(EBSEQFILE) | cut -f 1 | tr -d '"' | sort | uniq > $(WORKDIR)/diffexp.molids.txt

$(WORKDIR)/expr.diffexp.rsem.dat:		$(RSEMFILE) $(WORKDIR)/diffexp.molids.txt
						$(BINDIR)/selex $(WORKDIR)/diffexp.molids.txt <(tail -n +2 $(RSEMFILE) | tr -d '"') > $(WORKDIR)/expr.diffexp.rsem.dat.temp
						cat <(head -n 1 $(RSEMFILE)) $(WORKDIR)/expr.diffexp.rsem.dat.temp > $(WORKDIR)/expr.diffexp.rsem.dat
						rm $(WORKDIR)/expr.diffexp.rsem.dat.temp

$(WORKDIR)/expr.diffexp.rsem.dat.withFC:	$(EBSEQFILE) $(WORKDIR)/expr.diffexp.rsem.dat
						$(BINDIR)/addfc $(WORKDIR)/expr.diffexp.rsem.dat $(EBSEQFILE) > $(WORKDIR)/expr.diffexp.rsem.dat.withFC


$(PNG):						$(WORKDIR)/expr.diffexp.rsem.dat.withFC $(RSEMFILE)
						$(BINDIR)/de-viz $(SAMPLEARG) --before=$(WORKDIR)/before.norm.png --after=$(WORKDIR)/after.norm.png --norm=$(RSEMFILE) --heatmap=$(PNG) --columns < $(WORKDIR)/expr.diffexp.rsem.dat.withFC
